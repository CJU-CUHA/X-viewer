name: Spring Boot with Gradle Deployment

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. JDK 21 ì„¤ì • (Docker Composeì—ì„œ openjdk:21ì„ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ ë²„ì „ ë§ì¶¤)
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: "21"
          distribution: "temurin"
          cache: gradle

      # 3. ë¹„ë°€ ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ê¸° (application.properties)
      - name: Import secrets
        run: |
          mkdir -p ./src/main/resources
          echo "${{ secrets.APPLICATION_PROPERTIES }}" > ./src/main/resources/application.properties
        shell: bash

      # # 4. Gradleì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë¹Œë“œ
      # - name: Build with Gradle
      #   run: |
      #     cd BE
      #     chmod +x gradlew
      #     ./gradlew build -x test --no-daemon

      # 5. SSH ì—ì´ì „íŠ¸ ì„¤ì •
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 6. ì›ê²© ì„œë²„ë¥¼ known_hostsì— ì¶”ê°€í•˜ì—¬ í˜¸ìŠ¤íŠ¸ ê²€ì¦ ìš°íšŒ
      - name: Add remote server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # #7. ë¹Œë“œëœ JAR íŒŒì¼ì„ SCPë¥¼ í†µí•´ ì›ê²© ì„œë²„ë¡œ ì „ì†¡
      # - name: Transfer built jar via SCP
      #   run: |
      #     scp -v -O -P ${{ secrets.SERVER_PORT }} BE/build/libs/*.jar ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:~/enjiso/deploy/beyoung/build

      # # 7. ë¹Œë“œëœ JAR íŒŒì¼ì„ Rsyncë¥¼ í†µí•´ ì›ê²© ì„œë²„ë¡œ ì „ì†¡
      # - name: Transfer built jar via Rsync
      #   run: |
      #     rsync -avz --progress -e "ssh -p ${{ secrets.SERVER_PORT }}" BE/build/libs/*.jar ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:~/enjiso/deploy/beyoung/build
      #   shell: bash

      #  # 7. ë¹Œë“œëœ JAR íŒŒì¼ì„ Rsyncë¥¼ í†µí•´ ì›ê²© ì„œë²„ë¡œ ì „ì†¡
      # - name: Transfer built jar via Rsync
      #   run: |
      #     echo "ğŸ“‚ í˜„ì¬ ë¹Œë“œëœ íŒŒì¼ ëª©ë¡:"
      #     ls -lh BE/build/libs/

      #     echo "ğŸš€ Rsyncë¡œ JAR íŒŒì¼ ì „ì†¡ ì¤‘..."
      #     rsync -avz --progress --partial --bwlimit=0 -e "ssh -o ServerAliveInterval=60 -p ${{ secrets.SERVER_PORT }}" BE/build/libs/*.jar ${{ secrets.SSH_USER }}@${{ secrets.SERVER_IP }}:~/enjiso/deploy/beyoung/build

      #   shell: bash

      # 8. ì›ê²© ì„œë²„ì—ì„œ Docker Composeë¥¼ ì‚¬ìš©í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
      - name: Execute remote commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
              # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í›„ git pull
              cd /home/***/enjiso/Prototype
              git checkout main
              git pull origin main
              cd BE
              # Gradle ë¹Œë“œ ì„¤ì •
              chmod +x gradlew
              ./gradlew build --no-daemon

              # JAR íŒŒì¼ ì´ë¦„ ë³€ê²½
              mv ~/enjiso/Prototype/BE/build/libs/BE-0.0.1-SNAPSHOT.jar ~/enjiso/Prototype/BE/build/libs/app.jar

              # Docker Composeë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
              cd ~/enjiso/Prototype/BE
              docker-compose down
              docker-compose build --no-cache
              docker-compose up -d
